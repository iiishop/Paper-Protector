<style>
  /* Serial Monitor Specific Styles */

  /* Topic Group Styles */
  .topic-group {
    margin-bottom: var(--spacing-md);
    animation: slideIn 0.2s ease-out;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(-10px);
    }

    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .topic-header {
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: var(--spacing-sm);
    padding: var(--spacing-sm);
    background-color: var(--primary-light);
    border-radius: var(--border-radius);
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
  }

  /* Messages List Styles */
  .messages-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
  }

  .message-item {
    padding: var(--spacing-sm);
    background-color: var(--surface-color);
    border-left: 3px solid var(--secondary-color);
    border-radius: var(--border-radius);
    font-size: var(--font-size-sm);
    transition: transform 0.1s ease;
    animation: messageAppear 0.2s ease-out;
  }

  @keyframes messageAppear {
    from {
      opacity: 0;
      transform: translateY(-5px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .message-item:hover {
    transform: translateX(2px);
    box-shadow: var(--shadow-sm);
  }

  .message-timestamp {
    color: var(--text-secondary);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .message-topic {
    color: var(--primary-color);
    font-size: 0.8rem;
    font-weight: 600;
    margin-left: var(--spacing-sm);
    padding: 2px var(--spacing-xs);
    background-color: var(--primary-light);
    border-radius: var(--border-radius);
  }

  .message-payload {
    margin-top: var(--spacing-xs);
    font-family: "Courier New", Courier, monospace;
    word-break: break-all;
    color: var(--text-primary);
    background-color: var(--background-color);
    padding: var(--spacing-xs);
    border-radius: var(--border-radius);
  }

  /* Subscription List Styles */
  #subscribed-topics-list {
    max-height: 200px;
    overflow-y: auto;
  }

  #subscribed-topics-list .module-list-item {
    transition: background-color 0.2s ease;
  }

  #subscribed-topics-list .module-list-item:hover {
    background-color: var(--primary-light);
  }

  /* Form Styles */
  #subscription-form,
  #publish-form {
    background-color: var(--background-color);
    padding: var(--spacing-md);
    border-radius: var(--border-radius);
  }

  /* Messages Container Styles */
  #messages-container {
    background-color: var(--background-color);
    min-height: 300px;
    max-height: 500px;
  }

  #messages-container:empty::after {
    content: "ç­‰å¾…æ¶ˆæ¯...";
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100%;
    color: var(--text-secondary);
  }

  /* Feedback Styles */
  #publish-feedback .module-message {
    animation: fadeInDown 0.3s ease-out;
  }

  @keyframes fadeInDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Button Styles */
  .btn {
    transition: all 0.2s ease;
  }

  .btn:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  .btn:active {
    transform: translateY(0);
  }

  /* Responsive Styles */
  @media (max-width: 768px) {
    .module-form-row {
      flex-direction: column;
    }

    .module-form-row button {
      width: 100%;
    }

    #messages-container {
      max-height: 400px;
    }
  }
</style>

<!-- Serial Monitor Module -->
<div class="module-header">
  <h2 class="module-title">ä¸²å£ç›‘è§†å™¨</h2>
  <div class="module-actions">
    <button class="btn btn-secondary" id="clear-messages-btn">æ¸…ç©ºæ¶ˆæ¯</button>
  </div>
</div>

<div class="module-content">
  <!-- Subscription Management Section -->
  <div class="module-section">
    <h3 class="module-section-title">è®¢é˜…ç®¡ç†</h3>
    <form class="module-form" id="subscription-form">
      <div class="module-form-row">
        <div class="module-form-group">
          <label for="subscribe-topic">ä¸»é¢˜</label>
          <input type="text" id="subscribe-topic" placeholder="ä¾‹å¦‚: sensor/temp" required />
        </div>
        <button type="submit" class="btn btn-primary">è®¢é˜…</button>
      </div>
    </form>

    <div class="mt-md">
      <strong>å·²è®¢é˜…ä¸»é¢˜:</strong>
      <ul class="module-list" id="subscribed-topics-list">
        <li class="module-list-item text-muted">æš‚æ— è®¢é˜…</li>
      </ul>
    </div>
  </div>

  <!-- All Messages Debug Section -->
  <div class="module-section">
    <h3 class="module-section-title">ğŸ› æ‰€æœ‰ä¸²å£æ¶ˆæ¯ (è°ƒè¯•)</h3>
    <div class="module-scrollable" id="all-messages-container" style="max-height: 300px;">
      <div class="text-muted text-center p-md">ç­‰å¾…æ¶ˆæ¯...</div>
    </div>
    <div style="margin-top: var(--spacing-sm); font-size: var(--font-size-sm); color: var(--text-secondary);">
      æ˜¾ç¤ºæœ€è¿‘ 100 æ¡æ¶ˆæ¯ Â· æ€»è®¡: <span id="total-messages-count">0</span> æ¡
    </div>
  </div>

  <!-- Message Display Section -->
  <div class="module-section">
    <h3 class="module-section-title">æ¶ˆæ¯æ˜¾ç¤º (æŒ‰ä¸»é¢˜åˆ†ç»„)</h3>
    <div class="module-scrollable" id="messages-container">
      <div class="text-muted text-center p-md">ç­‰å¾…æ¶ˆæ¯...</div>
    </div>
  </div>

  <!-- Message Sending Section -->
  <div class="module-section">
    <h3 class="module-section-title">å‘é€æ¶ˆæ¯</h3>
    <form class="module-form" id="publish-form">
      <div class="module-form-group">
        <label for="publish-topic">ä¸»é¢˜</label>
        <input type="text" id="publish-topic" placeholder="ä¾‹å¦‚: led/control" required />
      </div>
      <div class="module-form-group">
        <label for="publish-payload">å†…å®¹</label>
        <textarea id="publish-payload" rows="3" placeholder="ä¾‹å¦‚: ON" required></textarea>
      </div>
      <button type="submit" class="btn btn-primary">å‘é€</button>
    </form>

    <!-- Feedback Message Area -->
    <div id="publish-feedback" class="mt-md"></div>
  </div>
</div>

<script>
  /**
   * Serial Monitor Module
   * Manages topic subscriptions, displays messages by topic, and sends messages
   */

  // Module state
  let serialMonitorState = {
    pubsubClient: null,
    subscribedTopics: new Set(),
    messagesByTopic: new Map(), // topic -> array of messages
    allMessages: [], // æ‰€æœ‰ä¸²å£æ¶ˆæ¯çš„å†å²è®°å½•
    maxMessagesPerTopic: 100,
    maxAllMessages: 500, // å…¨å±€æ¶ˆæ¯æœ€å¤§æ•°é‡
  };

  /**
   * Initialize the serial monitor module
   * This function is called by the module loader
   */
  function init_serial_monitor(pubsubClient) {
    console.log("Initializing Serial Monitor module...");

    serialMonitorState.pubsubClient = pubsubClient;

    // ç›‘å¬æ‰€æœ‰æ¶ˆæ¯ï¼ˆç”¨äºè°ƒè¯•ï¼‰
    pubsubClient.onMessage((message) => {
      if (message.type === 'message' && message.source === 'arduino') {
        addToAllMessages(message.topic, message.payload, 'received');
      }
    });
  } else if (message.source === 'user' || message.direction === 'sent') {
    addToAllMessages(message.topic, message.payload, 'sent');
  }
      }
    });

  // Set up event listeners
  setupSubscriptionForm();
  setupPublishForm();
  setupClearButton();

  console.log("Serial Monitor module initialized");
  }

  /**
   * Add message to all messages list (for debugging)
   */
  function addToAllMessages(topic, payload, direction = 'received') {
    const message = {
      topic: topic,
      payload: payload,
      timestamp: new Date(),
      direction: direction // 'sent' or 'received'
    };

    serialMonitorState.allMessages.push(message);

    // Limit array size
    if (serialMonitorState.allMessages.length > serialMonitorState.maxAllMessages) {
      serialMonitorState.allMessages.shift();
    }

    // Update all messages display
    updateAllMessagesDisplay();
  }

  /**
   * Update all messages display
   */
  function updateAllMessagesDisplay() {
    const container = document.getElementById("all-messages-container");
    if (!container) return;

    if (serialMonitorState.allMessages.length === 0) {
      container.innerHTML = '<div class="text-muted text-center p-md">ç­‰å¾…æ¶ˆæ¯...</div>';
      return;
    }

    // Clear container
    container.innerHTML = "";

    // Display all messages in reverse order (newest first)
    const messagesToShow = serialMonitorState.allMessages.slice().reverse().slice(0, 100);

    messagesToShow.forEach((msg) => {
      const messageItem = document.createElement("div");
      messageItem.className = "message-item";

      // æ ¹æ®æ¶ˆæ¯æ–¹å‘è®¾ç½®ä¸åŒçš„è¾¹æ¡†é¢œè‰²
      if (msg.direction === 'sent') {
        messageItem.style.borderLeftColor = "var(--warning-color)";
      } else {
        messageItem.style.borderLeftColor = "var(--secondary-color)";
      }

      const timestamp = document.createElement("span");
      timestamp.className = "message-timestamp";
      timestamp.textContent = formatTimestamp(msg.timestamp);

      const directionIcon = document.createElement("span");
      directionIcon.textContent = msg.direction === 'sent' ? 'â†‘' : 'â†“';
      directionIcon.style.marginLeft = "var(--spacing-xs)";
      directionIcon.style.fontSize = "1rem";
      directionIcon.style.color = msg.direction === 'sent' ? 'var(--warning-color)' : 'var(--secondary-color)';
      directionIcon.title = msg.direction === 'sent' ? 'å‘é€åˆ°Arduino' : 'ä»Arduinoæ¥æ”¶';

      const topicSpan = document.createElement("span");
      topicSpan.className = "message-topic";
      topicSpan.textContent = msg.topic;
      topicSpan.style.color = "var(--primary-color)";
      topicSpan.style.fontWeight = "600";
      topicSpan.style.marginLeft = "var(--spacing-sm)";

      const payload = document.createElement("div");
      payload.className = "message-payload";
      payload.textContent = msg.payload;

      const header = document.createElement("div");
      header.style.display = "flex";
      header.style.alignItems = "center";
      header.style.marginBottom = "var(--spacing-xs)";
      header.appendChild(timestamp);
      header.appendChild(directionIcon);
      header.appendChild(topicSpan);

      messageItem.appendChild(header);
      messageItem.appendChild(payload);
      container.appendChild(messageItem);
    });

    // Auto scroll to top (newest message)
    container.scrollTop = 0;
  }

  /**
   * Setup subscription form handler
   */
  function setupSubscriptionForm() {
    const form = document.getElementById("subscription-form");
    const topicInput = document.getElementById("subscribe-topic");

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const topic = topicInput.value.trim();
      if (!topic) {
        return;
      }

      // Check if already subscribed
      if (serialMonitorState.subscribedTopics.has(topic)) {
        showFeedback("publish-feedback", `å·²ç»è®¢é˜…äº†ä¸»é¢˜: ${topic}`, "warning");
        return;
      }

      // Subscribe to topic
      subscribeToTopic(topic);

      // Clear input
      topicInput.value = "";
    });
  }

  /**
   * Subscribe to a topic
   */
  function subscribeToTopic(topic) {
    const callback = (receivedTopic, payload) => {
      handleIncomingMessage(receivedTopic, payload);
    };

    // Subscribe through PubSubClient
    serialMonitorState.pubsubClient.subscribe(topic, callback);

    // Add to subscribed topics
    serialMonitorState.subscribedTopics.add(topic);

    // Initialize message array for this topic
    if (!serialMonitorState.messagesByTopic.has(topic)) {
      serialMonitorState.messagesByTopic.set(topic, []);
    }

    // Update UI
    updateSubscribedTopicsList();

    console.log(`Subscribed to topic: ${topic}`);
  }

  /**
   * Unsubscribe from a topic
   */
  function unsubscribeFromTopic(topic) {
    // Unsubscribe through PubSubClient
    serialMonitorState.pubsubClient.unsubscribe(topic);

    // Remove from subscribed topics
    serialMonitorState.subscribedTopics.delete(topic);

    // Update UI
    updateSubscribedTopicsList();
    updateMessagesDisplay();

    console.log(`Unsubscribed from topic: ${topic}`);
  }

  /**
   * Update the subscribed topics list in UI
   */
  function updateSubscribedTopicsList() {
    const listElement = document.getElementById("subscribed-topics-list");

    if (serialMonitorState.subscribedTopics.size === 0) {
      listElement.innerHTML =
        '<li class="module-list-item text-muted">æš‚æ— è®¢é˜…</li>';
      return;
    }

    listElement.innerHTML = "";

    serialMonitorState.subscribedTopics.forEach((topic) => {
      const li = document.createElement("li");
      li.className = "module-list-item";

      const topicSpan = document.createElement("span");
      topicSpan.textContent = topic;

      const unsubBtn = document.createElement("button");
      unsubBtn.className = "btn btn-danger";
      unsubBtn.textContent = "å–æ¶ˆè®¢é˜…";
      unsubBtn.style.padding = "4px 8px";
      unsubBtn.style.fontSize = "12px";
      unsubBtn.onclick = () => unsubscribeFromTopic(topic);

      li.appendChild(topicSpan);
      li.appendChild(unsubBtn);
      listElement.appendChild(li);
    });
  }

  /**
   * Handle incoming message
   */
  function handleIncomingMessage(topic, payload) {
    // Add message to topic's message array
    if (!serialMonitorState.messagesByTopic.has(topic)) {
      serialMonitorState.messagesByTopic.set(topic, []);
    }

    const messages = serialMonitorState.messagesByTopic.get(topic);
    messages.push({
      topic: topic,
      payload: payload,
      timestamp: new Date(),
    });

    // Limit message history
    if (messages.length > serialMonitorState.maxMessagesPerTopic) {
      messages.shift();
    }

    // Update display
    updateMessagesDisplay();

    // Auto-scroll to latest message
    scrollToLatestMessage();

    // Update total message count
    updateTotalMessageCount();
  }

  /**
   * Update total message count display
   */
  function updateTotalMessageCount() {
    const countElement = document.getElementById("total-messages-count");
    if (countElement) {
      countElement.textContent = serialMonitorState.allMessages.length;
    }
  }

  /**
   * Update messages display (grouped by topic)
   */
  function updateMessagesDisplay() {
    const container = document.getElementById("messages-container");

    // Check if there are any messages
    let hasMessages = false;
    for (const messages of serialMonitorState.messagesByTopic.values()) {
      if (messages.length > 0) {
        hasMessages = true;
        break;
      }
    }

    if (!hasMessages) {
      container.innerHTML =
        '<div class="text-muted text-center p-md">ç­‰å¾…æ¶ˆæ¯...</div>';
      return;
    }

    // Clear container
    container.innerHTML = "";

    // Display messages grouped by topic
    serialMonitorState.subscribedTopics.forEach((topic) => {
      const messages = serialMonitorState.messagesByTopic.get(topic) || [];

      if (messages.length === 0) {
        return;
      }

      // Create topic group
      const topicGroup = document.createElement("div");
      topicGroup.className = "topic-group";
      topicGroup.style.marginBottom = "var(--spacing-md)";

      // Topic header
      const topicHeader = document.createElement("div");
      topicHeader.className = "topic-header";
      topicHeader.style.fontWeight = "600";
      topicHeader.style.color = "var(--primary-color)";
      topicHeader.style.marginBottom = "var(--spacing-sm)";
      topicHeader.style.padding = "var(--spacing-sm)";
      topicHeader.style.backgroundColor = "var(--primary-light)";
      topicHeader.style.borderRadius = "var(--border-radius)";
      topicHeader.textContent = `ğŸ“¡ ${topic} (${messages.length})`;

      topicGroup.appendChild(topicHeader);

      // Messages list
      const messagesList = document.createElement("div");
      messagesList.className = "messages-list";

      messages.forEach((msg) => {
        const messageItem = document.createElement("div");
        messageItem.className = "message-item";
        messageItem.style.padding = "var(--spacing-sm)";
        messageItem.style.marginBottom = "var(--spacing-xs)";
        messageItem.style.backgroundColor = "var(--surface-color)";
        messageItem.style.borderLeft = "3px solid var(--secondary-color)";
        messageItem.style.borderRadius = "var(--border-radius)";
        messageItem.style.fontSize = "var(--font-size-sm)";

        const timestamp = document.createElement("div");
        timestamp.className = "message-timestamp";
        timestamp.style.color = "var(--text-secondary)";
        timestamp.style.fontSize = "var(--font-size-sm)";
        timestamp.textContent = formatTimestamp(msg.timestamp);

        const payload = document.createElement("div");
        payload.className = "message-payload";
        payload.style.marginTop = "var(--spacing-xs)";
        payload.style.fontFamily = "monospace";
        payload.style.wordBreak = "break-all";
        payload.textContent = msg.payload;

        messageItem.appendChild(timestamp);
        messageItem.appendChild(payload);
        messagesList.appendChild(messageItem);
      });

      topicGroup.appendChild(messagesList);
      container.appendChild(topicGroup);
    });
  }

  /**
   * Format timestamp for display
   */
  function formatTimestamp(date) {
    const hours = String(date.getHours()).padStart(2, "0");
    const minutes = String(date.getMinutes()).padStart(2, "0");
    const seconds = String(date.getSeconds()).padStart(2, "0");
    const ms = String(date.getMilliseconds()).padStart(3, "0");
    return `${hours}:${minutes}:${seconds}.${ms}`;
  }

  /**
   * Scroll to the latest message
   */
  function scrollToLatestMessage() {
    const container = document.getElementById("messages-container");
    if (container) {
      // Smooth scroll to bottom
      container.scrollTop = container.scrollHeight;
    }
  }

  /**
   * Setup publish form handler
   */
  function setupPublishForm() {
    const form = document.getElementById("publish-form");
    const topicInput = document.getElementById("publish-topic");
    const payloadInput = document.getElementById("publish-payload");

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const topic = topicInput.value.trim();
      const payload = payloadInput.value.trim();

      // Validate inputs
      if (!topic || !payload) {
        showFeedback("publish-feedback", "ä¸»é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º", "error");
        return;
      }

      // Publish message
      const success = serialMonitorState.pubsubClient.publish(topic, payload);

      if (success) {
        showFeedback(
          "publish-feedback",
          `æ¶ˆæ¯å·²å‘é€åˆ°ä¸»é¢˜: ${topic}`,
          "success"
        );

        // Clear inputs
        topicInput.value = "";
        payloadInput.value = "";
      } else {
        showFeedback("publish-feedback", "å‘é€å¤±è´¥: WebSocketæœªè¿æ¥", "error");
      }
    });
  }

  /**
   * Setup clear button
   */
  function setupClearButton() {
    const clearBtn = document.getElementById("clear-messages-btn");

    clearBtn.addEventListener("click", () => {
      // Clear all messages
      serialMonitorState.messagesByTopic.clear();
      serialMonitorState.allMessages = [];

      // Reinitialize message arrays for subscribed topics
      serialMonitorState.subscribedTopics.forEach((topic) => {
        serialMonitorState.messagesByTopic.set(topic, []);
      });

      // Update display
      updateMessagesDisplay();
      updateAllMessagesDisplay();
      updateTotalMessageCount();

      console.log("Messages cleared");
    });
  }

  /**
   * Show feedback message
   */
  function showFeedback(elementId, message, type = "info") {
    const feedbackElement = document.getElementById(elementId);

    feedbackElement.innerHTML = `
        <div class="module-message ${type}">
            ${message}
        </div>
    `;

    // Auto-hide after 3 seconds
    setTimeout(() => {
      feedbackElement.innerHTML = "";
    }, 3000);
  }

  /**
   * Cleanup function (called when module is unloaded)
   */
  function cleanup_serial_monitor() {
    console.log("Cleaning up Serial Monitor module...");

    // Unsubscribe from all topics
    serialMonitorState.subscribedTopics.forEach((topic) => {
      serialMonitorState.pubsubClient.unsubscribe(topic);
    });

    // Clear state
    serialMonitorState.subscribedTopics.clear();
    serialMonitorState.messagesByTopic.clear();

    console.log("Serial Monitor module cleaned up");
  }
</script>